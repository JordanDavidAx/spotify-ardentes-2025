<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify x Ardentes 2025</title>
    <style>
        :root {
            --spotify-green: #1DB954;
            --ardentes-orange: #FF6B35;
            --ardentes-red: #E63946;
            --dark-bg: #191414;
            --card-bg: #282828;
            --text-light: #FFFFFF;
            --text-muted: #B3B3B3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #191414 0%, #333 50%, #FF6B35 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        header h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .github-badge {
            background: var(--spotify-green);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
        }

        .section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            max-width: 800px;
            width: 100%;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange), var(--ardentes-red));
            border-radius: 22px;
            z-index: -1;
        }

        .setup-step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .step-number {
            background: var(--spotify-green);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-content {
            display: inline-block;
            vertical-align: top;
            width: calc(100% - 50px);
        }

        .url-display {
            background: var(--dark-bg);
            border: 1px solid var(--spotify-green);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--spotify-green);
            word-break: break-all;
            cursor: pointer;
        }

        .client-id-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--spotify-green);
            border-radius: 10px;
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: monospace;
            font-size: 1rem;
            margin: 15px 0;
        }

        .spotify-btn {
            background: var(--spotify-green);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 20px 0;
        }

        .spotify-btn:hover {
            background: #1ed760;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(29, 185, 84, 0.3);
        }

        .spotify-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--text-muted);
            border-top: 4px solid var(--spotify-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--spotify-green);
            background: var(--spotify-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--spotify-green);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .artists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .artist-match {
            background: linear-gradient(135deg, var(--spotify-green), var(--ardentes-orange));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .artist-match:hover {
            transform: translateY(-5px) scale(1.02);
        }

        .no-matches {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .error-message, .success-message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message {
            background: var(--ardentes-red);
            color: white;
        }

        .success-message {
            background: var(--spotify-green);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .reset-btn {
            background: var(--ardentes-orange);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: var(--ardentes-red);
            transform: translateY(-2px);
        }

        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--text-muted);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 30px 20px;
            }
            
            .artists-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
        }

        .copy-btn {
            background: var(--ardentes-orange);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎵 Spotify x Les Ardentes 2025</h1>
            <p>Découvre quels artistes de tes likes sont au festival !</p>
            <div class="github-badge">✅ App pré-configurée</div>
        </header>

        <main>
            <!-- Section de connexion -->
            <div id="setup-section" class="section">
                <div class="card">
                    <h2>🎵 Découvre tes artistes des Ardentes 2025</h2>
                    <p>Connecte-toi à Spotify pour analyser tes likes et voir quels artistes du festival tu écoutes déjà !</p>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin: 20px 0;">
                        <h3>📊 Ce que nous allons analyser :</h3>
                        <ul style="text-align: left; margin: 15px 0; padding-left: 20px;">
                            <li>Tes likes Spotify (maximum 1000)</li>
                            <li>Comparaison avec 160+ artistes des Ardentes 2025</li>
                            <li>Statistiques personnalisées avec vraie lineup</li>
                        </ul>
                    </div>

                    <button id="connect-btn" class="spotify-btn">
                        <span>🎧</span>
                        Se connecter avec Spotify
                    </button>
                    
                    <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-muted);">
                        🔒 Tes données restent privées et ne sont jamais sauvegardées<br>
                        ✅ Application pré-configurée - connexion directe !
                    </div>
                </div>
            </div>

            <!-- Section de chargement -->
            <div id="loading-section" class="section hidden">
                <div class="card">
                    <div class="spinner"></div>
                    <h2>Analyse en cours...</h2>
                    <p>Récupération de tes likes et comparaison avec les artistes des Ardentes 2025</p>
                </div>
            </div>

            <!-- Section des résultats -->
            <div id="results-section" class="section hidden">
                <div class="card">
                    <h2>🎉 Tes artistes des Ardentes 2025</h2>
                    <div id="user-info" class="user-info"></div>
                    <div id="stats-container"></div>
                    <div id="matching-artists" class="artists-grid"></div>
                    
                    <div class="action-buttons">
                        <button id="share-btn" class="spotify-btn">📱 Partager</button>
                        <button id="reset-btn" class="reset-btn">🔄 Recommencer</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Créé avec ❤️ pour les fans des Ardentes | Données Spotify via l'API officielle</p>
            <p style="font-size: 0.8rem;">🚀 Hébergé sur Vercel - Prêt à l'emploi</p>
        </footer>
    </div>

    <script>
        // Configuration - Client ID configuré (Authorization Code PKCE)
        const CONFIG = {
            CLIENT_ID: '90a205dc07554ea7b4d5e54e097c52f7',
            REDIRECT_URI: window.location.href.split('?')[0].split('#')[0],
            SCOPES: 'user-library-read user-read-private'
        };

        // Fonctions utilitaires pour PKCE
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        function base64URLEncode(array) {
            return btoa(String.fromCharCode(...array))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(digest));
        }

        // Fonction de logging
        function logDebug(message, data = null) {
            console.log(`🎵 [Spotify Debug] ${message}`, data || '');
            
            // Afficher aussi dans l'interface
            const debugDiv = document.getElementById('debug-log') || createDebugDiv();
            const debugContent = debugDiv.querySelector('#debug-content') || debugDiv;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.cssText = 'margin: 3px 0; font-size: 0.7rem; color: #B3B3B3; line-height: 1.2;';
            
            const dataStr = data ? (typeof data === 'string' ? data : JSON.stringify(data, null, 1)) : '';
            logEntry.innerHTML = `<span style="color: #1DB954;">[${timestamp}]</span> ${message} ${dataStr}`;
            
            debugContent.appendChild(logEntry);
            
            // Auto-scroll vers le bas
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function createDebugDiv() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debug-log';
            debugDiv.style.cssText = `
                position: fixed; bottom: 10px; right: 10px; 
                width: 350px; max-height: 250px; overflow-y: auto;
                background: rgba(0,0,0,0.9); border-radius: 10px; 
                padding: 15px; font-family: monospace; font-size: 0.7rem;
                z-index: 1000; border: 2px solid #1DB954;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            // Ajouter un titre et bouton clear
            debugDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #1DB954;">
                    <span style="color: #1DB954; font-weight: bold;">🎵 Debug Spotify</span>
                    <button onclick="document.getElementById('debug-log').innerHTML = this.parentElement.outerHTML" 
                            style="background: #FF6B35; border: none; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; cursor: pointer;">
                        Clear
                    </button>
                </div>
                <div id="debug-content"></div>
            `;
            
            document.body.appendChild(debugDiv);
            return debugDiv;
        }

        // Liste des vrais artistes des Ardentes 2025
        const ARDENTES_ARTISTS = [
            '1pliké140', '22heures30', '2L', '2much', '6ix9ine', '999999999',
            'Achim', 'Adèle Castillon', 'Afem Syko', 'Airod', 'Alex Brehm', 'Alonzo',
            'AMK', 'Apashe', 'Arma Jackson', 'Artem', 'Atticus', 'aupinard',
            'Bao An', 'Basswell', 'Bekar', 'Blokys', 'Boub\'z', 'Bouss', 'Bu$hi',
            'CARV', 'Cassie Raptor', 'Creeds', 'DA Uzi', 'Damn Low', 'Damso',
            'David Guetta', 'Decost', 'Dimension Bonus', 'Dj Bea', 'Dj Flambelle',
            'Dj Sean Macson', 'Durdenhauer', 'Eargasm God', 'Ebony', 'Eczodia',
            'Eli Džejn', 'Enima', 'Evil Grimace', 'Franglish', 'Gazo', 'Genezio',
            'Gims', 'Grand Master Rai', 'Green Montana', 'Gucci Mane', 'Guy2Bezbar',
            'Géo', 'Hades', 'Halfpipe Records', 'Hamza', 'Hatik', 'HD la Relève',
            'Heuss L\'enfoiré', 'High & Fines Herbes', 'Himra', 'Holy Priest',
            'Honey Golden', 'Hunter', 'I Hate Models', 'J Balvin', 'Jersey',
            'Jeune Lion', 'Jeune Pouce', 'Jok\'air', 'Jolagreen23', 'Jungeli',
            'Jungle Jack', 'Kaaris', 'Kari Bee', 'Kay The Prodigy', 'Keeqaid',
            'Ken Carson', 'Key Glock', 'KLM', 'L2B', 'La Fouine', 'La Mano 1.9',
            'Latto', 'Lauravioli', 'Lazer Dim 700', 'Le H', 'Lessss', 'Lil Kitty',
            'Lil Tecca', 'Lolalita', 'Louise Albann', 'Mandragora', 'Marhu',
            'Martin Vachiery', 'Mary M', 'Mataya', 'Merveille', 'Miro',
            'Moji x Sboy', 'Mopao', 'Mustard', 'Ninho & Niska', 'Oguz', 'Omaks',
            'Onlynumbers', 'Osirus Jack', 'Partynextdoor', 'Pawlowski', 'Primero',
            'Raivy', 'Rim\'k', 'Ritchie Santos', 'Roxane Peyronnenc', 'Sahareya',
            'SahBabii', 'SCH', 'SDM', 'Sentimental Rave', 'Sevdaliza', 'Sfera Ebbasta',
            'Shlømo', 'Silence ! (Protokseed & Sköne)', 'Sonny Rave', 'Soolking',
            'Stony Stone', 'Sublife', 'Swae Lee', 'Tayc', 'Taylor', 'thaHomey',
            'Theodort', 'THÉA', 'Tiakola', 'TIF', 'Todiefor', 'Trippie Redd',
            'Trym', 'Tsuki', 'Ty Dolla $ign', 'Urumi', 'Usky', 'Vald',
            'Vanessa Parish Crooks', 'Ven1', 'Vladimir Cauchemar', 'Von Bikrav',
            'Whoisinnocent', 'Yelsha', 'Yend', 'Yorssy', 'Young Thug',
            'Youssef Swatt\'s', 'Zamdane', 'Zequin', 'Zeu', 'ZKR',
            'Zoey Hasselbank', 'Zorza'
        ];

        // Variables globales
        let accessToken = null;
        let userProfile = null;
        let userTracks = [];
        let matchingArtists = [];

        // Éléments DOM
        const setupSection = document.getElementById('setup-section');
        const loadingSection = document.getElementById('loading-section');
        const resultsSection = document.getElementById('results-section');
        const connectBtn = document.getElementById('connect-btn');
        const resetBtn = document.getElementById('reset-btn');
        const shareBtn = document.getElementById('share-btn');

        // Fonction pour échanger le code d'autorisation contre un token
        async function exchangeCodeForToken(authCode) {
            try {
                logDebug('🔄 Échange du code d\'autorisation contre un token');
                
                const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
                if (!codeVerifier) {
                    throw new Error('Code verifier manquant');
                }

                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: authCode,
                        redirect_uri: CONFIG.REDIRECT_URI,
                        client_id: CONFIG.CLIENT_ID,
                        code_verifier: codeVerifier
                    })
                });

                logDebug('Réponse de Spotify token endpoint', { 
                    status: response.status, 
                    ok: response.ok 
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    logDebug('❌ Erreur token exchange', errorData);
                    throw new Error(`Token exchange failed: ${response.status} - ${errorData}`);
                }

                const tokenData = await response.json();
                logDebug('✅ Token reçu avec succès', { 
                    access_token: tokenData.access_token?.substring(0, 10) + '...',
                    expires_in: tokenData.expires_in 
                });

                // Nettoyer le code verifier
                sessionStorage.removeItem('spotify_code_verifier');

                return tokenData.access_token;
                
            } catch (error) {
                logDebug('❌ Erreur lors de l\'échange de token', error);
                throw error;
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            logDebug('🎵 Application démarrée');
            
            // Vérifier si on revient de Spotify avec un code d'autorisation
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                logDebug('❌ Erreur d\'autorisation Spotify', error);
                showError(`Erreur d'autorisation: ${error}`);
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (authCode) {
                logDebug('🔑 Code d\'autorisation reçu', authCode.substring(0, 10) + '...');
                
                try {
                    showSection('loading');
                    accessToken = await exchangeCodeForToken(authCode);
                    
                    // Nettoyer l'URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Démarrer l'analyse
                    await startAnalysis();
                    
                } catch (error) {
                    logDebug('❌ Erreur lors de l\'échange de token', error);
                    showError('Erreur lors de la connexion: ' + error.message);
                    showSection('setup');
                }
                return;
            }

            logDebug('👋 Prêt pour la connexion');

            // Bouton de connexion
            connectBtn.addEventListener('click', () => {
                loginToSpotify();
            });

            // Bouton reset
            resetBtn.addEventListener('click', () => {
                showSection('setup');
            });

            // Bouton partage
            shareBtn.addEventListener('click', () => {
                shareResults();
            });
        });

        async function loginToSpotify() {
            try {
                logDebug('🚀 Démarrage de l\'authentification Spotify');
                logDebug('Configuration', {
                    CLIENT_ID: CONFIG.CLIENT_ID,
                    REDIRECT_URI: CONFIG.REDIRECT_URI,
                    SCOPES: CONFIG.SCOPES
                });

                // Générer code verifier et challenge pour PKCE
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Sauvegarder le code verifier pour l'échange de token
                sessionStorage.setItem('spotify_code_verifier', codeVerifier);
                
                logDebug('PKCE codes générés', {
                    verifier: codeVerifier.substring(0, 10) + '...',
                    challenge: codeChallenge.substring(0, 10) + '...'
                });

                // Construire l'URL d'autorisation avec PKCE
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `client_id=${CONFIG.CLIENT_ID}&` +
                    `response_type=code&` +
                    `redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&` +
                    `scope=${encodeURIComponent(CONFIG.SCOPES)}&` +
                    `code_challenge_method=S256&` +
                    `code_challenge=${codeChallenge}&` +
                    `show_dialog=true`;
                
                logDebug('Redirection vers Spotify', { authUrl });
                window.location.href = authUrl;
                
            } catch (error) {
                logDebug('❌ Erreur lors de l\'authentification', error);
                showError('Erreur lors de l\'authentification: ' + error.message);
            }
        }

        async function startAnalysis() {
            logDebug('📊 Démarrage de l\'analyse');
            showSection('loading');
            
            try {
                logDebug('1️⃣ Récupération du profil utilisateur');
                userProfile = await getUserProfile();
                
                logDebug('2️⃣ Récupération des likes', `Utilisateur: ${userProfile.display_name}`);
                userTracks = await getAllUserTracks();
                
                logDebug('3️⃣ Recherche des correspondances', `${userTracks.length} likes récupérés`);
                matchingArtists = findMatchingArtists();
                
                logDebug('4️⃣ Affichage des résultats', `${matchingArtists.length} artistes trouvés`);
                displayResults();
                
                showMessage('✅ Analyse terminée avec succès !');
                logDebug('🎉 Analyse terminée avec succès');
                
            } catch (error) {
                logDebug('❌ Erreur lors de l\'analyse', error);
                showError('Erreur lors de l\'analyse: ' + error.message);
                showSection('setup');
            }
        }

        async function getUserProfile() {
            logDebug('👤 Appel API: récupération du profil utilisateur');
            
            const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            logDebug('Réponse API profil', { 
                status: response.status, 
                ok: response.ok,
                statusText: response.statusText 
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                logDebug('❌ Erreur API profil', errorText);
                throw new Error(`Erreur API profil: ${response.status} - ${errorText}`);
            }
            
            const profile = await response.json();
            logDebug('✅ Profil récupéré', { 
                user: profile.display_name, 
                id: profile.id 
            });
            
            return profile;
        }

        async function getAllUserTracks() {
            logDebug('🎵 Appel API: récupération des likes');
            
            let allTracks = [];
            let url = 'https://api.spotify.com/v1/me/tracks?limit=50';
            let pageCount = 0;
            
            while (url && allTracks.length < 1000) {
                pageCount++;
                logDebug(`📄 Page ${pageCount}`, `URL: ${url.substring(0, 50)}...`);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                logDebug(`Réponse API tracks page ${pageCount}`, { 
                    status: response.status, 
                    ok: response.ok 
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    logDebug('❌ Erreur API tracks', errorText);
                    break;
                }
                
                const data = await response.json();
                allTracks = allTracks.concat(data.items);
                url = data.next;
                
                logDebug(`✅ Page ${pageCount} récupérée`, { 
                    itemsThisPage: data.items.length,
                    totalSoFar: allTracks.length,
                    hasNext: !!data.next 
                });
                
                // Délai pour éviter le rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            logDebug('🎵 Récupération des likes terminée', { 
                totalTracks: allTracks.length,
                pages: pageCount 
            });
            
            return allTracks;
        }

        function findMatchingArtists() {
            logDebug('🔍 Analyse des correspondances d\'artistes');
            
            const userArtists = new Set();
            
            // Extraire tous les artistes des likes de l'utilisateur
            userTracks.forEach(item => {
                if (item.track?.artists) {
                    item.track.artists.forEach(artist => {
                        userArtists.add(artist.name.toLowerCase());
                    });
                }
            });

            logDebug('Artistes uniques dans les likes', { count: userArtists.size });
            logDebug('Artistes des Ardentes à chercher', { count: ARDENTES_ARTISTS.length });

            // Chercher les correspondances
            const matches = ARDENTES_ARTISTS.filter(artist => 
                userArtists.has(artist.toLowerCase())
            ).map(artist => {
                const matchingTracks = userTracks.filter(item => 
                    item.track?.artists?.some(a => 
                        a.name.toLowerCase() === artist.toLowerCase()
                    )
                ).slice(0, 3);

                logDebug(`✅ Match trouvé: ${artist}`, { tracks: matchingTracks.length });
                
                return {
                    name: artist,
                    tracks: matchingTracks
                };
            });

            logDebug('🎯 Résultat final', { 
                matchingArtists: matches.length,
                artists: matches.map(m => m.name)
            });

            return matches;
        }

        function displayResults() {
            showSection('results');

            // Info utilisateur
            document.getElementById('user-info').innerHTML = `
                <div class="user-avatar">🎵</div>
                <div>
                    <h3>Salut ${userProfile.display_name || 'Utilisateur'} ! 👋</h3>
                    <p>${userTracks.length} likes analysés</p>
                </div>
            `;

            // Statistiques
            const statsHtml = `
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number">${matchingArtists.length}</div>
                        <div class="stat-label">Artistes trouvés</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${userTracks.length}</div>
                        <div class="stat-label">Likes analysés</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${Math.round((matchingArtists.length / ARDENTES_ARTISTS.length) * 100)}%</div>
                        <div class="stat-label">Du festival découvert</div>
                    </div>
                </div>
            `;
            document.getElementById('stats-container').innerHTML = statsHtml;

            // Artistes correspondants
            const artistsGrid = document.getElementById('matching-artists');
            if (matchingArtists.length === 0) {
                artistsGrid.innerHTML = `
                    <div class="no-matches">
                        <h3>🎵 Nouveaux horizons musicaux !</h3>
                        <p>Tu n'as pas encore découvert ces artistes des Ardentes 2025.</p>
                        <p>C'est l'occasion parfaite d'élargir tes goûts ! 🚀</p>
                    </div>
                `;
            } else {
                artistsGrid.innerHTML = matchingArtists.map(artist => `
                    <div class="artist-match fade-in">
                        <h4>🎤 ${artist.name}</h4>
                        <p><strong>${artist.tracks.length}</strong> chanson${artist.tracks.length > 1 ? 's' : ''}</p>
                        <p style="font-size: 0.9rem; opacity: 0.9;">
                            ${artist.tracks.map(item => item.track.name).slice(0, 2).join(', ')}
                        </p>
                    </div>
                `).join('');
            }
        }

        function shareResults() {
            const text = matchingArtists.length > 0 
                ? `🎵 J'ai trouvé ${matchingArtists.length} artistes des Ardentes 2025 dans mes likes Spotify ! 🎶`
                : `🎵 J'ai analysé mes likes pour les Ardentes 2025 ! 🎶`;
            
            const url = 'https://spotify-ardentes-2025.vercel.app/';
            const fullText = `${text}\n\nDécouvre tes artistes sur : ${url}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Spotify x Ardentes 2025',
                    text: fullText,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(fullText).then(() => {
                    showMessage('Message copié dans le presse-papiers ! 📋');
                }).catch(() => {
                    showMessage(`Partage : ${fullText}`);
                });
            }
        }



        function showSection(section) {
            [setupSection, loadingSection, resultsSection].forEach(el => {
                el.classList.add('hidden');
            });
            
            switch(section) {
                case 'setup': setupSection.classList.remove('hidden'); break;
                case 'loading': loadingSection.classList.remove('hidden'); break;
                case 'results': resultsSection.classList.remove('hidden'); break;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('main'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('main'));
            setTimeout(() => messageDiv.remove(), 3000);
        }
    </script>
</body>
</html> 