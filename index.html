<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify x Ardentes 2025</title>
    <script src="https://js-cdn.music.apple.com/musickit/v3/musickit.js" async></script>
    <style>
        :root {
            --spotify-green: #1DB954;
            --ardentes-orange: #FF6B35;
            --ardentes-red: #E63946;
            --dark-bg: #191414;
            --card-bg: #282828;
            --text-light: #FFFFFF;
            --text-muted: #B3B3B3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #191414 0%, #333 50%, #FF6B35 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 0;
        }

        header h1 {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            font-size: 1.2rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .github-badge {
            background: var(--spotify-green);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: inline-block;
        }

        .section {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 40px;
        }

        .hidden {
            display: none !important;
        }

        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
            max-width: 800px;
            width: 100%;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange), var(--ardentes-red));
            border-radius: 22px;
            z-index: -1;
        }

        .setup-step {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .step-number {
            background: var(--spotify-green);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .step-content {
            display: inline-block;
            vertical-align: top;
            width: calc(100% - 50px);
        }

        .url-display {
            background: var(--dark-bg);
            border: 1px solid var(--spotify-green);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--spotify-green);
            word-break: break-all;
            cursor: pointer;
        }

        .client-id-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--spotify-green);
            border-radius: 10px;
            background: var(--dark-bg);
            color: var(--text-light);
            font-family: monospace;
            font-size: 1rem;
            margin: 15px 0;
        }

        .spotify-btn {
            background: var(--spotify-green);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
            margin: 20px 0;
        }

        .spotify-btn:hover {
            background: #1ed760;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(29, 185, 84, 0.3);
        }

        .spotify-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--text-muted);
            border-top: 4px solid var(--spotify-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--spotify-green);
            background: var(--spotify-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: var(--spotify-green);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .artists-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .artist-match {
            background: linear-gradient(135deg, var(--spotify-green), var(--ardentes-orange));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .artist-match:hover {
            transform: translateY(-5px) scale(1.02);
        }

        .no-matches {
            grid-column: 1/-1;
            text-align: center;
            padding: 40px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .error-message, .success-message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .error-message {
            background: var(--ardentes-red);
            color: white;
        }

        .success-message {
            background: var(--spotify-green);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .reset-btn {
            background: var(--ardentes-orange);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: var(--ardentes-red);
            transform: translateY(-2px);
        }

        footer {
            text-align: center;
            padding: 20px 0;
            color: var(--text-muted);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 30px 20px;
            }
            
            .artists-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
        }

        .copy-btn {
            background: var(--ardentes-orange);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bouton Voir plus */
        .voir-plus-btn {
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            transform: translateY(0);
        }

        .voir-plus-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: linear-gradient(135deg, var(--card-bg) 0%, #333 100%);
            margin: 2% auto;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease;
            border: 2px solid transparent;
            background-clip: padding-box;
            position: relative;
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange), var(--ardentes-red));
            border-radius: 22px;
            z-index: -1;
        }

        @keyframes modalSlideIn {
            from { 
                transform: translateY(-50px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 30px 30px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-muted);
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--spotify-green);
        }

        .artist-profile {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .artist-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--spotify-green);
            object-fit: cover;
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
        }

        .artist-details h2 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .artist-stats, .artist-genres {
            color: var(--text-muted);
            font-size: 1.1rem;
            margin: 5px 0;
        }

        .artist-stats {
            font-weight: bold;
            color: var(--spotify-green);
        }

        .modal-body {
            padding: 20px 30px 30px;
        }

        .modal-body h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--text-light);
            text-align: center;
        }

        .tracks-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .tracks-list::-webkit-scrollbar {
            width: 8px;
        }

        .tracks-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .tracks-list::-webkit-scrollbar-thumb {
            background: var(--spotify-green);
            border-radius: 4px;
        }

        .track-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .track-item:hover {
            background: rgba(29, 185, 84, 0.1);
            border-left-color: var(--spotify-green);
            transform: translateX(5px);
        }

        .track-number {
            color: var(--text-muted);
            font-weight: bold;
            min-width: 25px;
            text-align: center;
            font-size: 0.9rem;
        }

        .track-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-name {
            font-weight: bold;
            color: var(--text-light);
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-album {
            color: var(--text-muted);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration {
            color: var(--text-muted);
            font-size: 0.9rem;
            min-width: 40px;
            text-align: right;
        }

        .platform-selector {
            margin-bottom: 20px;
        }

        .platform-selector h3 {
            margin-bottom: 15px;
            text-align: center;
        }

        .platform-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .platform-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
            min-width: 200px;
        }

        .platform-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
        }

        .platform-btn.active {
            background: linear-gradient(45deg, var(--spotify-green), var(--ardentes-orange));
            border-color: transparent;
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.3);
        }

        .platform-btn span {
            font-size: 1.5rem;
        }

        .platform-btn div {
            text-align: left;
        }

        .platform-btn strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .platform-btn small {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .apple-help {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid var(--ardentes-orange);
            border-radius: 15px;
            text-align: center;
        }

        .apple-help h3 {
            color: var(--ardentes-orange);
            margin-bottom: 15px;
        }

        .apple-help a {
            color: var(--spotify-green);
            text-decoration: none;
        }

        .apple-help a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .platform-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .platform-btn {
                min-width: 280px;
                justify-content: center;
                text-align: center;
            }
            
            .platform-btn div {
                text-align: center;
            }
        }

        .config-section {
            margin-top: 20px;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(29, 185, 84, 0.3);
            transition: all 0.3s ease;
        }

        .config-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--text-light);
        }

        .config-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(29, 185, 84, 0.5);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            color: var(--text-light);
            font-size: 0.95rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .config-input:focus {
            outline: none;
            border-color: var(--spotify-green);
            box-shadow: 0 0 10px rgba(29, 185, 84, 0.3);
        }

        .config-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .save-btn {
            background: linear-gradient(45deg, var(--spotify-green), #1ed760);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 1rem;
            align-self: center;
            min-width: 150px;
        }

        .save-btn:hover {
            background: linear-gradient(45deg, #1ed760, var(--spotify-green));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(29, 185, 84, 0.4);
        }

        .config-help {
            margin-top: 10px;
            text-align: center;
        }

        .config-help a {
            color: var(--spotify-green);
            text-decoration: none;
            font-weight: bold;
        }

        .config-help a:hover {
            text-decoration: underline;
            color: #1ed760;
        }

        .reset-config-btn {
            background: linear-gradient(45deg, var(--ardentes-red), var(--ardentes-orange));
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .reset-config-btn:hover {
            background: linear-gradient(45deg, var(--ardentes-orange), var(--ardentes-red));
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        /* Styles pour les validations */
        .config-section.valid {
            border-color: var(--spotify-green);
            background: rgba(29, 185, 84, 0.1);
        }

        .config-section.invalid {
            border-color: var(--ardentes-red);
            background: rgba(231, 76, 60, 0.1);
        }

        /* Animation pour les champs requis */
        .config-input.required {
            animation: pulse-border 2s infinite;
        }

        @keyframes pulse-border {
            0% { border-color: rgba(29, 185, 84, 0.5); }
            50% { border-color: var(--spotify-green); }
            100% { border-color: rgba(29, 185, 84, 0.5); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Spotify x Les Ardentes 2025</h1>
            <p>D√©couvre quels artistes de tes likes sont au festival !</p>
            <div class="github-badge">‚úÖ App pr√©-configur√©e</div>
        </header>

        <main>
            <!-- Section de connexion -->
            <div id="setup-section" class="section">
                <div class="card">
                    <h2>üéµ D√©couvre tes artistes des Ardentes 2025</h2>
                    <p>Connecte-toi √† ta plateforme musicale pour analyser tes likes et voir quels artistes du festival tu √©coutes d√©j√† !</p>
                    
                    <!-- S√©lecteur de plateforme -->
                    <div class="platform-selector">
                        <h3>üì± Choisis ta plateforme :</h3>
                        <div class="platform-buttons">
                            <button id="spotify-btn" class="platform-btn active" onclick="selectPlatform('spotify')">
                                <span>üéß</span>
                                <div>
                                    <strong>Spotify</strong>
                                    <small>Connecte tes likes Spotify</small>
                                </div>
                            </button>
                            <button id="apple-btn" class="platform-btn" onclick="selectPlatform('apple')">
                                <span>üçé</span>
                                <div>
                                    <strong>Apple Music</strong>
                                    <small>Connecte ta biblioth√®que Apple Music</small>
                                </div>
                            </button>
                        </div>
                    </div>

                    <!-- Configuration Spotify -->
                    <div id="spotify-config" class="config-section">
                        <h3>üîß Configuration Spotify</h3>
                        <div class="config-form">
                            <div class="form-group">
                                <label for="spotify-client-id">Client ID Spotify :</label>
                                <input type="text" id="spotify-client-id" placeholder="Ton Client ID Spotify" 
                                       value="" class="config-input">
                                <small>üëâ <a href="https://developer.spotify.com/dashboard" target="_blank">Cr√©er une app Spotify</a></small>
                            </div>
                            <button onclick="saveSpotifyConfig()" class="save-btn">üíæ Sauvegarder</button>
                        </div>
                    </div>

                    <!-- Configuration Apple Music -->
                    <div id="apple-config" class="config-section hidden">
                        <h3>üîß Configuration Apple Music</h3>
                        <div class="config-form">
                            <div class="form-group">
                                <label for="apple-developer-token">Developer Token (JWT) :</label>
                                <textarea id="apple-developer-token" placeholder="Ton JWT Developer Token Apple Music" 
                                          rows="3" class="config-input"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="apple-team-id">Team ID :</label>
                                <input type="text" id="apple-team-id" placeholder="Ex: ABCD123456" 
                                       class="config-input">
                            </div>
                            <div class="form-group">
                                <label for="apple-key-id">Key ID :</label>
                                <input type="text" id="apple-key-id" placeholder="Ex: 1234567890" 
                                       class="config-input">
                            </div>
                            <button onclick="saveAppleMusicConfig()" class="save-btn">üíæ Sauvegarder</button>
                            <div class="config-help">
                                <small>üìñ <a href="#" onclick="showAppleGuide()">Guide de configuration Apple Music</a></small>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin: 20px 0;">
                        <h3>üìä Ce que nous allons analyser :</h3>
                        <ul style="text-align: left; margin: 15px 0; padding-left: 20px;">
                            <li id="platform-info">Tes likes Spotify (maximum 1000)</li>
                            <li>Comparaison avec 160+ artistes des Ardentes 2025</li>
                            <li>Statistiques personnalis√©es avec vraie lineup</li>
                        </ul>
                    </div>

                    <button id="connect-btn" class="spotify-btn">
                        <span id="connect-icon">üéß</span>
                        <span id="connect-text">Se connecter avec Spotify</span>
                    </button>
                    
                    <div style="margin-top: 20px; font-size: 0.9rem; color: var(--text-muted);">
                        üîí Tes donn√©es restent priv√©es et ne sont jamais sauvegard√©es<br>
                        <span id="config-status">‚ö†Ô∏è Configuration Spotify requise</span>
                        <br><button onclick="resetConfigs()" class="reset-config-btn">üóëÔ∏è R√©initialiser les configurations</button>
                    </div>

                    <!-- Section d'aide Apple Music (cach√©e par d√©faut) -->
                    <div id="apple-help" class="apple-help hidden">
                        <h3>üìã Guide Apple Music</h3>
                        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: left;">
                            <p><strong>Pour utiliser Apple Music :</strong></p>
                            <ol style="margin: 15px 0; padding-left: 20px;">
                                <li>Cr√©er un compte <a href="https://developer.apple.com" target="_blank" style="color: var(--spotify-green);">Apple Developer</a></li>
                                <li>Cr√©er un <strong>MusicKit Identifier</strong></li>
                                <li>G√©n√©rer une <strong>Private Key</strong> (.p8)</li>
                                <li>Cr√©er un <strong>JWT Developer Token</strong></li>
                                <li>Saisir les informations ci-dessus</li>
                            </ol>
                            <p>üìñ <a href="GUIDE-APPLE-MUSIC.md" target="_blank" style="color: var(--spotify-green);">Guide complet</a></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section de chargement -->
            <div id="loading-section" class="section hidden">
                <div class="card">
                    <div class="spinner"></div>
                    <h2>Analyse en cours...</h2>
                    <p>R√©cup√©ration de tes likes et comparaison avec les artistes des Ardentes 2025</p>
                </div>
            </div>

            <!-- Section des r√©sultats -->
            <div id="results-section" class="section hidden">
                <div class="card">
                    <h2>üéâ Tes artistes des Ardentes 2025</h2>
                    <div id="user-info" class="user-info"></div>
                    <div id="stats-container"></div>
                    <div id="matching-artists" class="artists-grid"></div>
                    
                    <div class="action-buttons">
                        <button id="share-btn" class="spotify-btn">üì± Partager</button>
                        <button id="reset-btn" class="reset-btn">üîÑ Recommencer</button>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <p>Cr√©√© avec ‚ù§Ô∏è pour les fans des Ardentes | Donn√©es Spotify via l'API officielle</p>
            <p style="font-size: 0.8rem;">üöÄ H√©berg√© sur Vercel - Pr√™t √† l'emploi</p>
        </footer>
    </div>

    <script>
        // Configuration dynamique depuis localStorage
        function getSpotifyConfig() {
            return {
                CLIENT_ID: localStorage.getItem('spotify_client_id') || '',
                REDIRECT_URI: window.location.href.split('?')[0].split('#')[0],
                SCOPES: 'user-library-read user-read-private'
            };
        }

        function getAppleMusicConfig() {
            return {
                DEVELOPER_TOKEN: localStorage.getItem('apple_music_token') || '',
                TEAM_ID: localStorage.getItem('apple_music_team_id') || '',
                KEY_ID: localStorage.getItem('apple_music_key_id') || '',
                APP_NAME: 'Spotify x Ardentes 2025',
                APP_BUILD: '1.0.0'
            };
        }

        // V√©rifier si les configurations sont compl√®tes
        function isSpotifyConfigured() {
            const config = getSpotifyConfig();
            return config.CLIENT_ID.length > 0;
        }

        function isAppleMusicConfigured() {
            const config = getAppleMusicConfig();
            return config.DEVELOPER_TOKEN.length > 0;
        }

        // Variables globales
        let selectedPlatform = 'spotify'; // 'spotify' ou 'apple'
        let musicKit = null;

        // Fonctions utilitaires pour PKCE
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        function base64URLEncode(array) {
            return btoa(String.fromCharCode(...array))
                .replace(/=/g, '')
                .replace(/\+/g, '-')
                .replace(/\//g, '_');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(digest));
        }

        // Fonction de logging
        function logDebug(message, data = null) {
            console.log(`üéµ [Spotify Debug] ${message}`, data || '');
            
            // Afficher aussi dans l'interface
            const debugDiv = document.getElementById('debug-log') || createDebugDiv();
            const debugContent = debugDiv.querySelector('#debug-content') || debugDiv;
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.cssText = 'margin: 3px 0; font-size: 0.7rem; color: #B3B3B3; line-height: 1.2;';
            
            const dataStr = data ? (typeof data === 'string' ? data : JSON.stringify(data, null, 1)) : '';
            logEntry.innerHTML = `<span style="color: #1DB954;">[${timestamp}]</span> ${message} ${dataStr}`;
            
            debugContent.appendChild(logEntry);
            
            // Auto-scroll vers le bas
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function createDebugDiv() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debug-log';
            debugDiv.style.cssText = `
                position: fixed; bottom: 10px; right: 10px; 
                width: 350px; max-height: 250px; overflow-y: auto;
                background: rgba(0,0,0,0.9); border-radius: 10px; 
                padding: 15px; font-family: monospace; font-size: 0.7rem;
                z-index: 1000; border: 2px solid #1DB954;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            
            // Ajouter un titre et bouton clear
            debugDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #1DB954;">
                    <span style="color: #1DB954; font-weight: bold;">üéµ Debug Spotify</span>
                    <button onclick="document.getElementById('debug-log').innerHTML = this.parentElement.outerHTML" 
                            style="background: #FF6B35; border: none; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.6rem; cursor: pointer;">
                        Clear
                    </button>
                </div>
                <div id="debug-content"></div>
            `;
            
            document.body.appendChild(debugDiv);
            return debugDiv;
        }

        // Liste des vrais artistes des Ardentes 2025
        const ARDENTES_ARTISTS = [
            '1plik√©140', '22heures30', '2L', '2much', '6ix9ine', '999999999',
            'Achim', 'Ad√®le Castillon', 'Afem Syko', 'Airod', 'Alex Brehm', 'Alonzo',
            'AMK', 'Apashe', 'Arma Jackson', 'Artem', 'Atticus', 'aupinard',
            'Bao An', 'Basswell', 'Bekar', 'Blokys', 'Boub\'z', 'Bouss', 'Bu$hi',
            'CARV', 'Cassie Raptor', 'Creeds', 'DA Uzi', 'Damn Low', 'Damso',
            'David Guetta', 'Decost', 'Dimension Bonus', 'Dj Bea', 'Dj Flambelle',
            'Dj Sean Macson', 'Durdenhauer', 'Eargasm God', 'Ebony', 'Eczodia',
            'Eli D≈æejn', 'Enima', 'Evil Grimace', 'Franglish', 'Gazo', 'Genezio',
            'Gims', 'Grand Master Rai', 'Green Montana', 'Gucci Mane', 'Guy2Bezbar',
            'G√©o', 'Hades', 'Halfpipe Records', 'Hamza', 'Hatik', 'HD la Rel√®ve',
            'Heuss L\'enfoir√©', 'High & Fines Herbes', 'Himra', 'Holy Priest',
            'Honey Golden', 'Hunter', 'I Hate Models', 'J Balvin', 'Jersey',
            'Jeune Lion', 'Jeune Pouce', 'Jok\'air', 'Jolagreen23', 'Jungeli',
            'Jungle Jack', 'Kaaris', 'Kari Bee', 'Kay The Prodigy', 'Keeqaid',
            'Ken Carson', 'Key Glock', 'KLM', 'L2B', 'La Fouine', 'La Mano 1.9',
            'Latto', 'Lauravioli', 'Lazer Dim 700', 'Le H', 'Lessss', 'Lil Kitty',
            'Lil Tecca', 'Lolalita', 'Louise Albann', 'Mandragora', 'Marhu',
            'Martin Vachiery', 'Mary M', 'Mataya', 'Merveille', 'Miro',
            'Moji x Sboy', 'Mopao', 'Mustard', 'Ninho & Niska', 'Oguz', 'Omaks',
            'Onlynumbers', 'Osirus Jack', 'Partynextdoor', 'Pawlowski', 'Primero',
            'Raivy', 'Rim\'k', 'Ritchie Santos', 'Roxane Peyronnenc', 'Sahareya',
            'SahBabii', 'SCH', 'SDM', 'Sentimental Rave', 'Sevdaliza', 'Sfera Ebbasta',
            'Shl√∏mo', 'Silence ! (Protokseed & Sk√∂ne)', 'Sonny Rave', 'Soolking',
            'Stony Stone', 'Sublife', 'Swae Lee', 'Tayc', 'Taylor', 'thaHomey',
            'Theodort', 'TH√âA', 'Tiakola', 'TIF', 'Todiefor', 'Trippie Redd',
            'Trym', 'Tsuki', 'Ty Dolla $ign', 'Urumi', 'Usky', 'Vald',
            'Vanessa Parish Crooks', 'Ven1', 'Vladimir Cauchemar', 'Von Bikrav',
            'Whoisinnocent', 'Yelsha', 'Yend', 'Yorssy', 'Young Thug',
            'Youssef Swatt\'s', 'Zamdane', 'Zequin', 'Zeu', 'ZKR',
            'Zoey Hasselbank', 'Zorza'
        ];

        // Variables globales
        let accessToken = null;
        let userProfile = null;
        let userTracks = [];
        let matchingArtists = [];

        // √âl√©ments DOM
        const setupSection = document.getElementById('setup-section');
        const loadingSection = document.getElementById('loading-section');
        const resultsSection = document.getElementById('results-section');
        const connectBtn = document.getElementById('connect-btn');
        const resetBtn = document.getElementById('reset-btn');
        const shareBtn = document.getElementById('share-btn');

        // Fonction pour √©changer le code d'autorisation contre un token
        async function exchangeCodeForToken(authCode) {
            const CONFIG = getSpotifyConfig();
            const codeVerifier = sessionStorage.getItem('spotify_code_verifier');
            
            if (!codeVerifier) {
                throw new Error('Code verifier manquant');
            }
            
            if (!CONFIG.CLIENT_ID) {
                throw new Error('Client ID Spotify non configur√©');
            }
            
            logDebug('üîÑ √âchange du code d\'autorisation contre un token d\'acc√®s');
            
            const body = new URLSearchParams({
                grant_type: 'authorization_code',
                code: authCode,
                redirect_uri: CONFIG.REDIRECT_URI,
                client_id: CONFIG.CLIENT_ID,
                code_verifier: codeVerifier
            });

            const response = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: body
            });

            logDebug('R√©ponse √©change token', { 
                status: response.status, 
                ok: response.ok,
                statusText: response.statusText 
            });

            if (!response.ok) {
                const errorData = await response.json();
                logDebug('‚ùå Erreur √©change token', errorData);
                throw new Error(`Erreur √©change token: ${errorData.error_description || errorData.error}`);
            }

            const data = await response.json();
            logDebug('‚úÖ Token d\'acc√®s obtenu', { 
                tokenType: data.token_type,
                expiresIn: data.expires_in,
                scope: data.scope
            });

            // Nettoyer le code verifier
            sessionStorage.removeItem('spotify_code_verifier');
            
            return data.access_token;
        }

        // Application principale
        document.addEventListener('DOMContentLoaded', async () => {
            logDebug('üéµ Application d√©marr√©e');

            // Initialiser les √©l√©ments DOM
            setupSection = document.getElementById('setup-section');
            loadingSection = document.getElementById('loading-section');
            resultsSection = document.getElementById('results-section');
            connectBtn = document.getElementById('connect-btn');
            shareBtn = document.getElementById('share-btn');
            resetBtn = document.getElementById('reset-btn');

            // Charger les configurations sauvegard√©es
            loadConfigs();

            // V√©rifier si on revient d'une autorisation Spotify
            const urlParams = new URLSearchParams(window.location.search);
            const authCode = urlParams.get('code');
            
            if (authCode) {
                logDebug('üîë Code d\'autorisation Spotify re√ßu');
                window.history.replaceState({}, document.title, window.location.pathname);
                
                try {
                    selectedPlatform = 'spotify';
                    accessToken = await exchangeCodeForToken(authCode);
                    await startSpotifyAnalysis();
                    return;
                } catch (error) {
                    logDebug('‚ùå Erreur traitement code autorisation', error);
                    showError('Erreur lors de l\'autorisation: ' + error.message);
                }
            }

            // Gestionnaires d'√©v√©nements
            connectBtn.addEventListener('click', handleConnect);
            shareBtn.addEventListener('click', shareResults);
            resetBtn.addEventListener('click', resetApp);
            
            // Initialiser l'interface
            updatePlatformInfo();
            updatePlatformUI();
            
            logDebug('üëã Application pr√™te');
        });

        async function handleConnect() {
            if (selectedPlatform === 'spotify') {
                if (!isSpotifyConfigured()) {
                    showError('Veuillez d\'abord configurer votre Client ID Spotify');
                    return;
                }
                await connectToSpotify();
            } else if (selectedPlatform === 'apple') {
                if (!isAppleMusicConfigured()) {
                    showError('Veuillez d\'abord configurer votre Developer Token Apple Music');
                    return;
                }
                await connectAppleMusic();
            }
        }

        async function connectToSpotify() {
            await loginToSpotify();
        }

        async function loginToSpotify() {
            try {
                const CONFIG = getSpotifyConfig();
                
                if (!CONFIG.CLIENT_ID) {
                    throw new Error('Client ID Spotify non configur√©');
                }
                
                logDebug('üöÄ D√©marrage de l\'authentification Spotify');
                logDebug('Configuration', {
                    CLIENT_ID: CONFIG.CLIENT_ID.substring(0, 10) + '...',
                    REDIRECT_URI: CONFIG.REDIRECT_URI,
                    SCOPES: CONFIG.SCOPES
                });

                // G√©n√©rer code verifier et challenge pour PKCE
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Sauvegarder le code verifier pour l'√©change de token
                sessionStorage.setItem('spotify_code_verifier', codeVerifier);
                
                logDebug('PKCE codes g√©n√©r√©s', {
                    verifier: codeVerifier.substring(0, 10) + '...',
                    challenge: codeChallenge.substring(0, 10) + '...'
                });

                // Construire l'URL d'autorisation avec PKCE
                const authUrl = `https://accounts.spotify.com/authorize?` +
                    `client_id=${CONFIG.CLIENT_ID}&` +
                    `response_type=code&` +
                    `redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&` +
                    `scope=${encodeURIComponent(CONFIG.SCOPES)}&` +
                    `code_challenge_method=S256&` +
                    `code_challenge=${codeChallenge}&` +
                    `show_dialog=true`;
                
                logDebug('Redirection vers Spotify', { authUrl });
                window.location.href = authUrl;
                
            } catch (error) {
                logDebug('‚ùå Erreur lors de l\'authentification', error);
                showError('Erreur lors de l\'authentification: ' + error.message);
            }
        }

        async function startSpotifyAnalysis() {
            logDebug('üìä D√©marrage analyse Spotify');
            showSection('loading');
            
            try {
                logDebug('1Ô∏è‚É£ R√©cup√©ration du profil utilisateur');
                userProfile = await getUserProfile();
                
                logDebug('2Ô∏è‚É£ R√©cup√©ration des likes', `Utilisateur: ${userProfile.display_name}`);
                userTracks = await getAllUserTracks();
                
                logDebug('3Ô∏è‚É£ Recherche des correspondances', `${userTracks.length} likes r√©cup√©r√©s`);
                matchingArtists = findMatchingArtists();
                
                logDebug('4Ô∏è‚É£ Affichage des r√©sultats', `${matchingArtists.length} artistes trouv√©s`);
                displayResults();
                
                showMessage('‚úÖ Analyse Spotify termin√©e avec succ√®s !');
                logDebug('üéâ Analyse Spotify termin√©e avec succ√®s');
                
            } catch (error) {
                logDebug('‚ùå Erreur lors de l\'analyse Spotify', error);
                showError('Erreur lors de l\'analyse Spotify: ' + error.message);
                showSection('setup');
            }
        }

        // Alias pour compatibilit√© avec le code existant
        async function startAnalysis() {
            return await startSpotifyAnalysis();
        }

        async function getUserProfile() {
            logDebug('üë§ Appel API: r√©cup√©ration du profil utilisateur');
            
            const response = await fetch('https://api.spotify.com/v1/me', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            
            logDebug('R√©ponse API profil', { 
                status: response.status, 
                ok: response.ok,
                statusText: response.statusText 
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                logDebug('‚ùå Erreur API profil', errorText);
                throw new Error(`Erreur API profil: ${response.status} - ${errorText}`);
            }
            
            const profile = await response.json();
            logDebug('‚úÖ Profil r√©cup√©r√©', { 
                user: profile.display_name, 
                id: profile.id 
            });
            
            return profile;
        }

        async function getAllUserTracks() {
            logDebug('üéµ Appel API: r√©cup√©ration des likes');
            
            let allTracks = [];
            let url = 'https://api.spotify.com/v1/me/tracks?limit=50';
            let pageCount = 0;
            
            while (url && allTracks.length < 1000) {
                pageCount++;
                logDebug(`üìÑ Page ${pageCount}`, `URL: ${url.substring(0, 50)}...`);
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                
                logDebug(`R√©ponse API tracks page ${pageCount}`, { 
                    status: response.status, 
                    ok: response.ok 
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    logDebug('‚ùå Erreur API tracks', errorText);
                    break;
                }
                
                const data = await response.json();
                allTracks = allTracks.concat(data.items);
                url = data.next;
                
                logDebug(`‚úÖ Page ${pageCount} r√©cup√©r√©e`, { 
                    itemsThisPage: data.items.length,
                    totalSoFar: allTracks.length,
                    hasNext: !!data.next 
                });
                
                // D√©lai pour √©viter le rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            logDebug('üéµ R√©cup√©ration des likes termin√©e', { 
                totalTracks: allTracks.length,
                pages: pageCount 
            });
            
            return allTracks;
        }

        function findMatchingArtists() {
            logDebug('üîç Analyse des correspondances d\'artistes');
            
            const userArtists = new Set();
            
            // Extraire tous les artistes des likes de l'utilisateur
            userTracks.forEach(item => {
                if (item.track?.artists) {
                    item.track.artists.forEach(artist => {
                        userArtists.add(artist.name.toLowerCase());
                    });
                }
            });

            logDebug('Artistes uniques dans les likes', { count: userArtists.size });
            logDebug('Artistes des Ardentes √† chercher', { count: ARDENTES_ARTISTS.length });

            // Chercher les correspondances
            const matches = ARDENTES_ARTISTS.filter(artist => 
                userArtists.has(artist.toLowerCase())
            ).map(artist => {
                const matchingTracks = userTracks.filter(item => 
                    item.track?.artists?.some(a => 
                        a.name.toLowerCase() === artist.toLowerCase()
                    )
                ); // ‚úÖ LIMITATION SUPPRIM√âE - TOUTES LES CHANSONS !

                console.log(`üé§ DEBUG: ${artist} - Chansons trouv√©es AVANT limitation: ${matchingTracks.length}`);
                console.log(`üìù DEBUG: D√©tail des chansons de ${artist}:`, matchingTracks.map(item => item.track.name));
                logDebug(`‚úÖ Match trouv√©: ${artist}`, { tracks: matchingTracks.length });
                
                return {
                    name: artist,
                    tracks: matchingTracks
                };
            });

            logDebug('üéØ R√©sultat final', { 
                matchingArtists: matches.length,
                artists: matches.map(m => m.name)
            });

            return matches;
        }

        function displayResults() {
            showSection('results');

            // Info utilisateur
            document.getElementById('user-info').innerHTML = `
                <div class="user-avatar">üéµ</div>
                <div>
                    <h3>Salut ${userProfile.display_name || 'Utilisateur'} ! üëã</h3>
                    <p>${userTracks.length} likes analys√©s</p>
                </div>
            `;

            // Statistiques
            const statsHtml = `
                <div class="stats">
                    <div class="stat">
                        <div class="stat-number">${matchingArtists.length}</div>
                        <div class="stat-label">Artistes trouv√©s</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${userTracks.length}</div>
                        <div class="stat-label">Likes analys√©s</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${Math.round((matchingArtists.length / ARDENTES_ARTISTS.length) * 100)}%</div>
                        <div class="stat-label">Du festival d√©couvert</div>
                    </div>
                </div>
            `;
            document.getElementById('stats-container').innerHTML = statsHtml;

            // Artistes correspondants
            const artistsGrid = document.getElementById('matching-artists');
            if (matchingArtists.length === 0) {
                artistsGrid.innerHTML = `
                    <div class="no-matches">
                        <h3>üéµ Nouveaux horizons musicaux !</h3>
                        <p>Tu n'as pas encore d√©couvert ces artistes des Ardentes 2025.</p>
                        <p>C'est l'occasion parfaite d'√©largir tes go√ªts ! üöÄ</p>
                    </div>
                `;
            } else {
                artistsGrid.innerHTML = matchingArtists.map(artist => {
                    const tracksList = artist.tracks.slice(0, 2).map(item => item.track.name).join(', ');
                    const hasMoreTracks = artist.tracks.length > 2;
                    
                    console.log(`üé§ DEBUG: Affichage ${artist.name} - ${artist.tracks.length} chansons, hasMoreTracks: ${hasMoreTracks}`);
                    
                    return `
                        <div class="artist-match fade-in">
                            <h4>üé§ ${artist.name}</h4>
                            <p><strong>${artist.tracks.length}</strong> chanson${artist.tracks.length > 1 ? 's' : ''}</p>
                            <p style="font-size: 0.9rem; opacity: 0.9;">
                                ${tracksList}${hasMoreTracks ? '...' : ''}
                            </p>
                            ${hasMoreTracks ? `<button class="voir-plus-btn" onclick="openArtistModal('${artist.name.replace(/'/g, "\\'")}')">Voir plus</button>` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        function shareResults() {
            const text = matchingArtists.length > 0 
                ? `üéµ J'ai trouv√© ${matchingArtists.length} artistes des Ardentes 2025 dans mes likes Spotify ! üé∂`
                : `üéµ J'ai analys√© mes likes pour les Ardentes 2025 ! üé∂`;
            
            const url = 'https://spotify-ardentes-2025.vercel.app/';
            const fullText = `${text}\n\nD√©couvre tes artistes sur : ${url}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Spotify x Ardentes 2025',
                    text: fullText,
                    url: url
                });
            } else {
                navigator.clipboard.writeText(fullText).then(() => {
                    showMessage('Message copi√© dans le presse-papiers ! üìã');
                }).catch(() => {
                    showMessage(`Partage : ${fullText}`);
                });
            }
        }

        function showSection(section) {
            [setupSection, loadingSection, resultsSection].forEach(el => {
                el.classList.add('hidden');
            });
            
            switch(section) {
                case 'setup': setupSection.classList.remove('hidden'); break;
                case 'loading': loadingSection.classList.remove('hidden'); break;
                case 'results': resultsSection.classList.remove('hidden'); break;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.container').insertBefore(errorDiv, document.querySelector('main'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success-message';
            messageDiv.textContent = message;
            document.querySelector('.container').insertBefore(messageDiv, document.querySelector('main'));
            setTimeout(() => messageDiv.remove(), 3000);
        }

        // ‚úÖ NOUVELLES FONCTIONS MODAL
        
        // Ouvrir la modal d'un artiste
        function openArtistModal(artistName) {
            console.log(`üé≠ DEBUG: Ouverture modal pour ${artistName}`);
            const artist = matchingArtists.find(a => a.name === artistName);
            if (!artist) {
                console.error(`‚ùå DEBUG: Artiste ${artistName} non trouv√© dans matchingArtists`);
                return;
            }
            
            console.log(`üìä DEBUG: Donn√©es artiste modal:`, {
                name: artist.name,
                tracksCount: artist.tracks.length,
                trackNames: artist.tracks.map(t => t.track.name)
            });
            
            const modal = document.getElementById('artistModal') || createArtistModal();
            const modalContent = modal.querySelector('.modal-content');
            
            modalContent.innerHTML = `
                <div class="modal-header">
                    <span class="modal-close" onclick="closeArtistModal()">&times;</span>
                    <div class="artist-profile">
                        <img src="https://via.placeholder.com/120x120/1DB954/FFFFFF?text=üéµ" alt="${artist.name}" class="artist-image">
                        <div class="artist-details">
                            <h2>${artist.name}</h2>
                            <p class="artist-stats">üéµ Artiste des Ardentes 2025</p>
                            <p class="artist-genres">D√©couvert dans tes likes Spotify !</p>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <h3>Tes chansons lik√©es (${artist.tracks.length})</h3>
                    <div class="tracks-list">
                        ${artist.tracks.map((item, index) => `
                            <div class="track-item">
                                <div class="track-number">${index + 1}</div>
                                <img src="${item.track.album?.images?.[2]?.url || item.track.album?.images?.[0]?.url || 'https://via.placeholder.com/50x50/282828/FFFFFF?text=üéµ'}" 
                                     alt="${item.track.name}" class="track-image">
                                <div class="track-info">
                                    <div class="track-name">${item.track.name}</div>
                                    <div class="track-album">${item.track.album?.name || 'Album inconnu'}</div>
                                </div>
                                <div class="track-duration">${formatDuration(item.track.duration_ms)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
            console.log(`‚úÖ DEBUG: Modal affich√©e avec ${artist.tracks.length} chansons`);
        }

        // Cr√©er la modal si elle n'existe pas
        function createArtistModal() {
            const modal = document.createElement('div');
            modal.id = 'artistModal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <!-- Contenu g√©n√©r√© dynamiquement -->
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fermer en cliquant √† l'ext√©rieur
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeArtistModal();
                }
            });
            
            return modal;
        }

        // Fermer la modal
        function closeArtistModal() {
            const modal = document.getElementById('artistModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Formater la dur√©e (ms -> mm:ss)
        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function selectPlatform(platform) {
            selectedPlatform = platform;
            updatePlatformInfo();
            updatePlatformUI();
        }

        function updatePlatformInfo() {
            const platformInfo = document.getElementById('platform-info');
            const connectIcon = document.getElementById('connect-icon');
            const connectText = document.getElementById('connect-text');
            const configStatus = document.getElementById('config-status');
            const appleHelp = document.getElementById('apple-help');
            const spotifyConfig = document.getElementById('spotify-config');
            const appleConfig = document.getElementById('apple-config');
            
            if (selectedPlatform === 'spotify') {
                platformInfo.textContent = 'Tes likes Spotify (maximum 1000)';
                connectIcon.textContent = 'üéß';
                connectText.textContent = 'Se connecter avec Spotify';
                
                // Afficher la configuration Spotify
                if (spotifyConfig) spotifyConfig.classList.remove('hidden');
                if (appleConfig) appleConfig.classList.add('hidden');
                if (appleHelp) appleHelp.classList.add('hidden');
                
                // V√©rifier et mettre √† jour l'√©tat de la configuration
                if (isSpotifyConfigured()) {
                    configStatus.innerHTML = '‚úÖ Spotify configur√© - connexion disponible !';
                    if (spotifyConfig) {
                        spotifyConfig.classList.add('valid');
                        spotifyConfig.classList.remove('invalid');
                    }
                } else {
                    configStatus.innerHTML = '‚ö†Ô∏è Configuration Spotify requise';
                    if (spotifyConfig) {
                        spotifyConfig.classList.add('invalid');
                        spotifyConfig.classList.remove('valid');
                    }
                }
            } else if (selectedPlatform === 'apple') {
                platformInfo.textContent = 'Ta biblioth√®que Apple Music (likes et ajouts)';
                connectIcon.textContent = 'üçé';
                connectText.textContent = 'Se connecter avec Apple Music';
                
                // Afficher la configuration Apple Music
                if (spotifyConfig) spotifyConfig.classList.add('hidden');
                if (appleConfig) appleConfig.classList.remove('hidden');
                
                // V√©rifier et mettre √† jour l'√©tat de la configuration
                if (isAppleMusicConfigured()) {
                    configStatus.innerHTML = '‚úÖ Apple Music configur√© - connexion disponible !';
                    if (appleHelp) appleHelp.classList.add('hidden');
                    if (appleConfig) {
                        appleConfig.classList.add('valid');
                        appleConfig.classList.remove('invalid');
                    }
                } else {
                    configStatus.innerHTML = '‚ö†Ô∏è Configuration Apple Music requise';
                    if (appleHelp) appleHelp.classList.remove('hidden');
                    if (appleConfig) {
                        appleConfig.classList.add('invalid');
                        appleConfig.classList.remove('valid');
                    }
                }
            }
        }

        function updatePlatformUI() {
            // Mettre √† jour les boutons de plateforme
            document.querySelectorAll('.platform-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${selectedPlatform}-btn`).classList.add('active');
        }

        // ===== FONCTIONS APPLE MUSIC =====

        async function initializeAppleMusic() {
            try {
                const APPLE_MUSIC_CONFIG = getAppleMusicConfig();
                
                logDebug('üçé Initialisation Apple Music MusicKit');
                
                if (!APPLE_MUSIC_CONFIG.DEVELOPER_TOKEN) {
                    throw new Error('Developer Token Apple Music non configur√©');
                }

                await MusicKit.configure({
                    developerToken: APPLE_MUSIC_CONFIG.DEVELOPER_TOKEN,
                    app: {
                        name: APPLE_MUSIC_CONFIG.APP_NAME,
                        build: APPLE_MUSIC_CONFIG.APP_BUILD
                    }
                });

                musicKit = MusicKit.getInstance();
                logDebug('‚úÖ Apple Music MusicKit initialis√©');
                return true;
            } catch (error) {
                logDebug('‚ùå Erreur initialisation Apple Music', error.message);
                return false;
            }
        }

        async function connectAppleMusic() {
            try {
                logDebug('üçé Connexion Apple Music');
                
                const initialized = await initializeAppleMusic();
                if (!initialized) {
                    throw new Error('Impossible d\'initialiser Apple Music');
                }

                const authorization = await musicKit.authorize();
                logDebug('‚úÖ Autorisation Apple Music obtenue');
                
                await startAppleMusicAnalysis();
            } catch (error) {
                logDebug('‚ùå Erreur connexion Apple Music', error.message);
                showError('Erreur de connexion Apple Music: ' + error.message);
                showSection('setup');
            }
        }

        async function startAppleMusicAnalysis() {
            showSection('loading');
            logDebug('üìä D√©marrage analyse Apple Music');
            
            try {
                // R√©cup√©rer le profil utilisateur
                userProfile = await getAppleMusicProfile();
                
                // R√©cup√©rer les morceaux de la biblioth√®que
                userTracks = await getAllAppleMusicTracks();
                
                // Analyser les correspondances (m√™me fonction que Spotify)
                matchingArtists = await findMatchingArtistsAppleMusic();
                
                // Afficher les r√©sultats
                displayResults();
                
                logDebug('üéâ Analyse Apple Music termin√©e avec succ√®s');
            } catch (error) {
                logDebug('‚ùå Erreur analyse Apple Music', error.message);
                showError('Erreur lors de l\'analyse Apple Music: ' + error.message);
                showSection('setup');
            }
        }

        async function getAppleMusicProfile() {
            logDebug('üë§ R√©cup√©ration profil Apple Music');
            
            // Apple Music n'a pas de profil public comme Spotify
            // On simule un profil bas√© sur l'√©tat de connexion
            const profile = {
                display_name: 'Utilisateur Apple Music',
                id: 'apple_music_user',
                images: []
            };
            
            logDebug('‚úÖ Profil Apple Music simul√©', { user: profile.display_name });
            return profile;
        }

        async function getAllAppleMusicTracks() {
            logDebug('üéµ R√©cup√©ration biblioth√®que Apple Music');
            
            try {
                let allTracks = [];
                let offset = 0;
                const limit = 100;
                let hasMore = true;
                let pageCount = 0;

                while (hasMore && allTracks.length < 1000) {
                    pageCount++;
                    logDebug(`üìÑ Page ${pageCount} Apple Music`, `Offset: ${offset}, Limit: ${limit}`);

                    // R√©cup√©rer les morceaux de la biblioth√®que
                    const response = await musicKit.api.library.songs(null, { 
                        offset: offset, 
                        limit: limit 
                    });

                    logDebug(`R√©ponse API Apple Music page ${pageCount}`, { 
                        itemsReceived: response.data?.length || 0
                    });

                    if (response.data && response.data.length > 0) {
                        // Convertir le format Apple Music vers le format Spotify pour compatibilit√©
                        const convertedTracks = response.data.map(song => ({
                            track: {
                                name: song.attributes.name,
                                artists: song.attributes.artistName ? [{ name: song.attributes.artistName }] : [],
                                album: {
                                    name: song.attributes.albumName,
                                    images: song.attributes.artwork ? [{
                                        url: song.attributes.artwork.url.replace('{w}', '300').replace('{h}', '300')
                                    }] : []
                                },
                                duration_ms: song.attributes.durationInMillis || 0
                            }
                        }));

                        allTracks = allTracks.concat(convertedTracks);
                        offset += limit;

                        logDebug(`‚úÖ Page ${pageCount} Apple Music r√©cup√©r√©e`, { 
                            itemsThisPage: convertedTracks.length,
                            totalSoFar: allTracks.length
                        });
                    } else {
                        hasMore = false;
                    }

                    // D√©lai pour √©viter le rate limiting
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                logDebug('üéµ R√©cup√©ration Apple Music termin√©e', { 
                    totalTracks: allTracks.length,
                    pages: pageCount 
                });

                return allTracks;
            } catch (error) {
                logDebug('‚ùå Erreur r√©cup√©ration Apple Music', error.message);
                throw new Error('Impossible de r√©cup√©rer la biblioth√®que Apple Music');
            }
        }

        async function findMatchingArtistsAppleMusic() {
            logDebug('üîç Analyse correspondances Apple Music');
            
            const userArtists = new Set();
            
            // Extraire tous les artistes de la biblioth√®que
            userTracks.forEach(item => {
                if (item.track?.artists) {
                    item.track.artists.forEach(artist => {
                        userArtists.add(artist.name.toLowerCase());
                    });
                }
            });

            logDebug('Artistes uniques Apple Music', { count: userArtists.size });
            logDebug('Artistes des Ardentes √† chercher', { count: ARDENTES_ARTISTS.length });

            // Chercher les correspondances (m√™me logique que Spotify)
            const matches = ARDENTES_ARTISTS.filter(artist => 
                userArtists.has(artist.toLowerCase())
            ).map(artist => {
                const matchingTracks = userTracks.filter(item => 
                    item.track?.artists?.some(a => 
                        a.name.toLowerCase() === artist.toLowerCase()
                    )
                );

                console.log(`üé§ DEBUG: ${artist} - Chansons Apple Music trouv√©es: ${matchingTracks.length}`);
                console.log(`üìù DEBUG: D√©tail Apple Music ${artist}:`, matchingTracks.map(item => item.track.name));
                logDebug(`‚úÖ Match Apple Music: ${artist}`, { tracks: matchingTracks.length });
                
                return {
                    name: artist,
                    tracks: matchingTracks
                };
            });

            logDebug('üéØ R√©sultat final Apple Music', { 
                matchingArtists: matches.length,
                artists: matches.map(m => m.name)
            });

            return matches;
        }

        function resetConfigs() {
            localStorage.removeItem('spotify_client_id');
            localStorage.removeItem('apple_music_token');
            localStorage.removeItem('apple_music_team_id');
            localStorage.removeItem('apple_music_key_id');
            showSection('setup');
            updatePlatformInfo();
            updatePlatformUI();
            loadConfigs();
        }

        // ===== GESTION DES CONFIGURATIONS =====

        function saveSpotifyConfig() {
            const clientId = document.getElementById('spotify-client-id').value.trim();
            
            if (!clientId) {
                showError('Veuillez saisir votre Client ID Spotify');
                document.getElementById('spotify-client-id').classList.add('required');
                return;
            }
            
            // Validation basique du format Client ID
            if (clientId.length < 20) {
                showError('Le Client ID Spotify semble trop court (format invalide)');
                return;
            }
            
            localStorage.setItem('spotify_client_id', clientId);
            showMessage('‚úÖ Configuration Spotify sauvegard√©e !');
            updatePlatformInfo();
            
            // Retirer l'animation "required"
            document.getElementById('spotify-client-id').classList.remove('required');
            
            // Marquer la section comme valide
            document.getElementById('spotify-config').classList.add('valid');
            document.getElementById('spotify-config').classList.remove('invalid');
            
            logDebug('Configuration Spotify sauvegard√©e', { clientId: clientId.substring(0, 10) + '...' });
        }

        function saveAppleMusicConfig() {
            const token = document.getElementById('apple-developer-token').value.trim();
            const teamId = document.getElementById('apple-team-id').value.trim();
            const keyId = document.getElementById('apple-key-id').value.trim();
            
            if (!token) {
                showError('Veuillez saisir votre Developer Token Apple Music');
                document.getElementById('apple-developer-token').classList.add('required');
                return;
            }
            
            // Validation basique du format JWT
            if (!token.includes('.') || token.split('.').length !== 3) {
                showError('Le Developer Token doit √™tre un JWT valide (format: header.payload.signature)');
                return;
            }
            
            localStorage.setItem('apple_music_token', token);
            localStorage.setItem('apple_music_team_id', teamId);
            localStorage.setItem('apple_music_key_id', keyId);
            
            showMessage('‚úÖ Configuration Apple Music sauvegard√©e !');
            updatePlatformInfo();
            
            // Retirer l'animation "required"
            document.getElementById('apple-developer-token').classList.remove('required');
            
            // Marquer la section comme valide
            document.getElementById('apple-config').classList.add('valid');
            document.getElementById('apple-config').classList.remove('invalid');
            
            logDebug('Configuration Apple Music sauvegard√©e', { 
                tokenLength: token.length,
                teamId: teamId,
                keyId: keyId
            });
        }

        function loadConfigs() {
            // Charger configuration Spotify
            const spotifyClientId = localStorage.getItem('spotify_client_id');
            if (spotifyClientId) {
                document.getElementById('spotify-client-id').value = spotifyClientId;
            }
            
            // Charger configuration Apple Music
            const appleToken = localStorage.getItem('apple_music_token');
            const appleTeamId = localStorage.getItem('apple_music_team_id');
            const appleKeyId = localStorage.getItem('apple_music_key_id');
            
            if (appleToken) {
                document.getElementById('apple-developer-token').value = appleToken;
            }
            if (appleTeamId) {
                document.getElementById('apple-team-id').value = appleTeamId;
            }
            if (appleKeyId) {
                document.getElementById('apple-key-id').value = appleKeyId;
            }
            
            // Valider les configurations charg√©es
            validateConfigurations();
            
            logDebug('Configurations charg√©es', {
                spotifyConfigured: !!spotifyClientId,
                appleConfigured: !!appleToken
            });
        }

        function validateConfigurations() {
            const spotifyConfig = document.getElementById('spotify-config');
            const appleConfig = document.getElementById('apple-config');
            
            // Valider Spotify
            if (isSpotifyConfigured()) {
                if (spotifyConfig) {
                    spotifyConfig.classList.add('valid');
                    spotifyConfig.classList.remove('invalid');
                }
            } else {
                if (spotifyConfig) {
                    spotifyConfig.classList.add('invalid');
                    spotifyConfig.classList.remove('valid');
                }
            }
            
            // Valider Apple Music
            if (isAppleMusicConfigured()) {
                if (appleConfig) {
                    appleConfig.classList.add('valid');
                    appleConfig.classList.remove('invalid');
                }
            } else {
                if (appleConfig) {
                    appleConfig.classList.add('invalid');
                    appleConfig.classList.remove('valid');
                }
            }
        }

        function showAppleGuide() {
            const appleHelp = document.getElementById('apple-help');
            if (appleHelp.classList.contains('hidden')) {
                appleHelp.classList.remove('hidden');
            } else {
                appleHelp.classList.add('hidden');
            }
        }

        function resetApp() {
            // R√©initialiser les variables globales
            accessToken = null;
            userProfile = null;
            userTracks = [];
            matchingArtists = [];
            
            // Retourner √† la section setup
            showSection('setup');
            
            logDebug('üîÑ Application r√©initialis√©e');
        }
    </script>
</body>
</html> 